<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{/admin/fragments/head :: head}"></head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thanh Toán - Checkout</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

<body class="bg-light">

<!-- Header -->
<div class="bg-primary text-white py-4 mb-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="mb-0">
                    <i class="fas fa-shopping-bag me-3"></i>
                    Thanh Toán
                </h1>
            </div>
            <div class="col-md-6 text-md-end">
                <a href="/cart" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left me-2"></i>
                    Quay lại giỏ hàng
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Step Progress -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between position-relative">
                <div class="text-center">
                    <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2"
                         style="width: 40px; height: 40px;">
                        <i class="fas fa-check"></i>
                    </div>
                    <small>Giỏ hàng</small>
                </div>
                <div class="text-center">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2"
                         style="width: 40px; height: 40px;">
                        2
                    </div>
                    <small>Thông tin giao hàng</small>
                </div>
                <div class="text-center">
                    <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2"
                         style="width: 40px; height: 40px;">
                        3
                    </div>
                    <small>Thanh toán</small>
                </div>
                <div class="text-center">
                    <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2"
                         style="width: 40px; height: 40px;">
                        4
                    </div>
                    <small>Hoàn thành</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert -->
    <div id="alertContainer"></div>

    <form id="checkoutForm" class="needs-validation" novalidate>
        <div class="row">
            <!-- Left - Delivery Info -->
            <div class="col-lg-7">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h4 class="mb-0 text-primary">
                            <i class="fas fa-shipping-fast me-2"></i>
                            Thông tin giao hàng
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Customer Info -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-user me-2 text-secondary"></i>
                                Thông tin người nhận
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="hoTen" class="form-label">Họ và tên <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="hoTen" name="hoTen" required>
                                    <div class="invalid-feedback">Vui lòng nhập họ và tên</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="soDienThoai" class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="soDienThoai" name="soDienThoai" required>
                                    <div class="invalid-feedback">Vui lòng nhập số điện thoại</div>
                                </div>
                            </div>
                        </div>

                        <!-- Address -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-map-marker-alt me-2 text-secondary"></i>
                                Địa chỉ giao hàng
                            </h5>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="tinhThanh" class="form-label">Tỉnh/Thành <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="tinhThanh" name="tinhThanh" required>
                                        <option value="">Chọn tỉnh/thành</option>
                                        <option value="hanoi">Hà Nội</option>
                                        <option value="hcm">TP. Hồ Chí Minh</option>
                                        <option value="danang">Đà Nẵng</option>
                                        <option value="haiphong">Hải Phòng</option>
                                        <option value="cantho">Cần Thơ</option>
                                    </select>
                                    <div class="invalid-feedback">Vui lòng chọn tỉnh/thành</div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="quanHuyen" class="form-label">Quận/Huyện <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="quanHuyen" name="quanHuyen" required>
                                        <option value="">Chọn quận/huyện</option>
                                    </select>
                                    <div class="invalid-feedback">Vui lòng chọn quận/huyện</div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="phuongXa" class="form-label">Phường/Xã <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select" id="phuongXa" name="phuongXa" required>
                                        <option value="">Chọn phường/xã</option>
                                    </select>
                                    <div class="invalid-feedback">Vui lòng chọn phường/xã</div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="diaChiChiTiet" class="form-label">Địa chỉ chi tiết <span
                                        class="text-danger">*</span></label>
                                <textarea class="form-control" id="diaChiChiTiet" name="diaChiChiTiet" rows="2"
                                          placeholder="Số nhà, tên đường..." required></textarea>
                                <div class="invalid-feedback">Vui lòng nhập địa chỉ chi tiết</div>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-credit-card me-2 text-secondary"></i>
                                Phương thức thanh toán
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="border rounded p-3 payment-method" data-method="cod">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="phuongThucThanhToan"
                                                   value="COD" id="cod">
                                            <label class="form-check-label w-100" for="cod">
                                                <div class="fw-bold">
                                                    <i class="fas fa-money-bill-wave me-2 text-success"></i>
                                                    Thanh toán khi nhận hàng
                                                </div>
                                                <small class="text-muted">Thanh toán bằng tiền mặt khi nhận hàng</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="border rounded p-3 payment-method" data-method="momo">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="phuongThucThanhToan"
                                                   value="MOMO" id="momo">
                                            <label class="form-check-label w-100" for="momo">
                                                <div class="fw-bold">
                                                    <i class="fas fa-wallet me-2 text-primary"></i>
                                                    Ví MoMo
                                                </div>
                                                <small class="text-muted">Thanh toán qua ví điện tử MoMo</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Note -->
                        <div class="mb-3">
                            <label for="ghiChu" class="form-label">
                                <i class="fas fa-sticky-note me-2 text-secondary"></i>
                                Ghi chú đơn hàng
                            </label>
                            <textarea class="form-control" id="ghiChu" name="ghiChu" rows="3"
                                      placeholder="Ghi chú về đơn hàng..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right - Order Summary -->
            <div class="col-lg-5">
                <div class="position-sticky" style="top: 20px;">
                    <!-- Products -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h5 class="mb-0 text-primary">
                                <i class="fas fa-list me-2"></i>
                                Sản phẩm đã chọn
                            </h5>
                        </div>
                        <div class="card-body p-2" style="max-height: 400px; overflow-y: auto;">
                            <div id="productsList"></div>
                        </div>
                    </div>

                    <!-- Summary -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-receipt me-2"></i>
                                Tóm tắt đơn hàng
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-3">
                                <span>Tạm tính:</span>
                                <span id="subtotal" class="fw-bold">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Phí vận chuyển:</span>
                                <span class="text-success fw-bold">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Giảm giá:</span>
                                <span id="discount" class="text-success fw-bold">0</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-4">
                                <strong class="fs-5">Tổng cộng:</strong>
                                <strong id="totalAmount" class="fs-5 text-danger">0</strong>
                            </div>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="voucherCode" placeholder="Mã giảm giá"
                                       readonly>
                                <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal"
                                        data-bs-target="#voucherModal">
                                    <i class="fas fa-ticket-alt"></i> Chọn
                                </button>
                            </div>
                            <button type="submit" class="btn btn-success w-100 btn-lg mb-3">
                                <i class="fas fa-lock me-2"></i>
                                Đặt hàng
                            </button>
                            <div class="text-center">
                                <small class="text-muted">
                                    <i class="fas fa-shield-alt me-1"></i>
                                    Thông tin được bảo mật
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Voucher Modal -->
<div class="modal fade" id="voucherModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-ticket-alt me-2"></i>
                    Chọn phiếu giảm giá
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="vouchersList">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="clearVoucherBtn">
                    <i class="fas fa-trash-alt me-1"></i> Bỏ chọn
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>-->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // Cập nhật lại class CheckoutPage với các method mới
    class CheckoutPage {
        constructor() {
            this.cartData = null;
            this.selectedVoucher = null;
            this.init();
        }

        init() {
            this.loadCartData();
            this.bindEvents();
            this.loadAvailableVouchers();
        }

        bindEvents() {
            // Payment method
            document.querySelectorAll('.payment-method').forEach(el => {
                el.addEventListener('click', () => {
                    const radio = el.querySelector('input[type="radio"]');
                    if (radio) radio.checked = true;
                    this.updatePaymentUI();
                });
            });

            // Address
            document.getElementById('tinhThanh').addEventListener('change', () => this.loadDistricts());
            document.getElementById('quanHuyen').addEventListener('change', () => this.loadWards());

            // Form
            document.getElementById('checkoutForm').addEventListener('submit', (e) => {
                e.preventDefault();
                if (this.validateForm()) this.processOrder();
            });

            // Voucher modal
            document.getElementById('voucherModal').addEventListener('shown.bs.modal', () => {
                this.loadAvailableVouchers();
            });

            // Clear voucher button
            document.getElementById('clearVoucherBtn').addEventListener('click', () => {
                this.clearVoucher();
            });
        }

        // Format currency to VND (e.g., 10000 -> 10.000 đ)
        formatCurrency(amount) {
            return amount.toLocaleString('vi-VN', { style: 'decimal', minimumFractionDigits: 0 }) + ' đ';
        }

        async loadCartData() {
            try {
                const response = await fetch('/checkout/cart-info');
                const data = await response.json();

                if (data.isEmpty) {
                    window.location.href = '/cart';
                    return;
                }

                this.cartData = data;
                this.renderProducts(data.items);
                this.updateSummary(data);
            } catch (error) {
                this.showAlert('Lỗi tải giỏ hàng', 'danger');
            }
        }

        renderProducts(items) {
            const container = document.getElementById('productsList');
            container.innerHTML = items.map(item => `
            <div class="border rounded p-2 mb-2">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        ${item.hinhAnh ?
                `<img src="${item.hinhAnh}" alt="${item.tenSanPham}" class="rounded" style="width: 50px; height: 50px; object-fit: cover;">` :
                `<div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;"><i class="fas fa-image text-muted"></i></div>`
            }
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1 small">${item.tenSanPham}</h6>
                        <div class="mb-1">
                            ${item.mauSac ? `<span class="badge bg-secondary">${item.mauSac}</span> ` : ''}
                            ${item.congSuat ? `<span class="badge bg-secondary">${item.congSuat}</span>` : ''}
                        </div>
                        <small class="text-muted">SL: ${item.soLuong}</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-danger small">${this.formatCurrency(item.tongTien)}</div>
                        <small class="text-muted">${this.formatCurrency(item.gia)}/cái</small>
                    </div>
                </div>
            </div>
        `).join('');
        }

        updateSummary(data) {
            document.getElementById('subtotal').textContent = this.formatCurrency(data.totalAmount);

            // Tính số tiền được giảm
            const discountAmount = this.calculateDiscountAmount(data.totalAmount);

            // Tính tổng tiền cuối cùng
            const finalAmount = data.totalAmount - discountAmount;

            // Cập nhật UI
            document.getElementById('discount').textContent = this.formatCurrency(-discountAmount);
            document.getElementById('totalAmount').textContent = this.formatCurrency(finalAmount);
        }

        updatePaymentUI() {
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('bg-light'));
            const selected = document.querySelector('input[name="phuongThucThanhToan"]:checked');
            if (selected) selected.closest('.payment-method').classList.add('bg-light');
        }

        loadDistricts() {
            const province = document.getElementById('tinhThanh').value;
            const districtSelect = document.getElementById('quanHuyen');
            const wardSelect = document.getElementById('phuongXa');

            districtSelect.innerHTML = '<option value="">Chọn quận/huyện</option>';
            wardSelect.innerHTML = '<option value="">Chọn phường/xã</option>';

            if (!province) return;

            const districts = {
                'hanoi': ['Ba Đình', 'Hoàn Kiếm', 'Tây Hồ', 'Long Biên', 'Cầu Giấy', 'Đống Đa'],
                'hcm': ['Quận 1', 'Quận 2', 'Quận 3', 'Quận 4', 'Quận 5', 'Quận 7'],
                'danang': ['Hải Châu', 'Thanh Khê', 'Sơn Trà', 'Ngũ Hành Sơn'],
                'haiphong': ['Hồng Bàng', 'Ngô Quyền', 'Lê Chân', 'Hải An'],
                'cantho': ['Ninh Kiều', 'Bình Thủy', 'Cái Răng', 'Ô Môn']
            };

            if (districts[province]) {
                districts[province].forEach(district => {
                    districtSelect.innerHTML += `<option value="${district}">${district}</option>`;
                });
            }
        }

        loadWards() {
            const district = document.getElementById('quanHuyen').value;
            const wardSelect = document.getElementById('phuongXa');

            wardSelect.innerHTML = '<option value="">Chọn phường/xã</option>';

            if (!district) return;

            // Mock wards
            const wards = ['Phường 1', 'Phường 2', 'Phường 3', 'Phường 4', 'Phường 5'];
            wards.forEach(ward => {
                wardSelect.innerHTML += `<option value="${ward}">${ward}</option>`;
            });
        }

        async loadAvailableVouchers() {
            const vouchersList = document.getElementById('vouchersList');
            vouchersList.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Đang tải...</span>
            </div>
            <p class="mt-2 text-muted">Đang tải danh sách phiếu giảm giá...</p>
        </div>
    `;

            try {
                const response = await fetch('/checkout/PGG');
                if (response.status === 401) {
                    vouchersList.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-lock text-warning fa-2x mb-2"></i>
                    <p class="text-muted">Vui lòng đăng nhập để xem phiếu giảm giá</p>
                </div>
            `;
                    return;
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const vouchers = await response.json();
                this.renderVouchers(vouchers);
            } catch (error) {
                console.error('Error loading vouchers:', error);
                // Xử lý lỗi
            }
        }

        renderVouchers(vouchers) {
            const container = document.getElementById('vouchersList');

            if (!vouchers || vouchers.length === 0) {
                container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-ticket-alt text-muted fa-2x mb-2"></i>
                <p class="text-muted">Không có phiếu giảm giá khả dụng</p>
                <small class="text-muted">Hãy theo dõi để không bỏ lỡ ưu đãi!</small>
            </div>
        `;
                return;
            }

            // ✅ SỬA: Cải thiện logic xác định loại voucher
            const getVoucherTypeInfo = (voucher) => {
                // Kiểm tra theo type trước
                if (voucher.type === 'public') {
                    return { text: 'Công khai', color: 'success', icon: 'globe' };
                } else if (voucher.type === 'private') {
                    return { text: 'Cá nhân', color: 'warning', icon: 'user' };
                }

                // Kiểm tra theo loaiPhieu
                if (voucher.loaiPhieu === true || voucher.loaiPhieu === 1) {
                    return { text: 'Công khai', color: 'success', icon: 'globe' };
                } else if (voucher.loaiPhieu === false || voucher.loaiPhieu === 0) {
                    return { text: 'Cá nhân', color: 'warning', icon: 'user' };
                }

                // Mặc định
                return { text: 'Không xác định', color: 'secondary', icon: 'question' };
            };

            // ✅ SỬA: Tách voucher theo loại để hiển thị rõ ràng
            const publicVouchers = vouchers.filter(v => v.type === 'public' || v.loaiPhieu === true);
            const privateVouchers = vouchers.filter(v => v.type === 'private' || v.loaiPhieu === false);

            console.log('DEBUG: Public vouchers count:', publicVouchers.length);
            console.log('DEBUG: Private vouchers count:', privateVouchers.length);

            let html = '';

            // Hiển thị voucher cá nhân trước (ưu tiên)
            if (privateVouchers.length > 0) {
                html += `
            <div class="mb-3">
                <h6 class="text-warning">
                    <i class="fas fa-user me-2"></i>
                    Phiếu giảm giá cá nhân (${privateVouchers.length})
                </h6>
                <hr>
            </div>
        `;
                html += this.renderVoucherGroup(privateVouchers);
            }

            // Hiển thị voucher công khai
            if (publicVouchers.length > 0) {
                html += `
            <div class="mb-3 ${privateVouchers.length > 0 ? 'mt-4' : ''}">
                <h6 class="text-success">
                    <i class="fas fa-globe me-2"></i>
                    Phiếu giảm giá công khai (${publicVouchers.length})
                </h6>
                <hr>
            </div>
        `;
                html += this.renderVoucherGroup(publicVouchers);
            }

            container.innerHTML = html;

            // Bind events
            document.querySelectorAll('.select-voucher').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const voucherData = JSON.parse(e.target.closest('.select-voucher').dataset.voucher);
                    this.selectVoucher(voucherData);
                });
            });
        }

        // ✅ THÊM: Method mới để render từng nhóm voucher
        renderVoucherGroup(vouchers) {
            const getVoucherTypeInfo = (voucher) => {
                if (voucher.type === 'public' || voucher.loaiPhieu === true) {
                    return { text: 'Công khai', color: 'success', icon: 'globe' };
                } else if (voucher.type === 'private' || voucher.loaiPhieu === false) {
                    return { text: 'Cá nhân', color: 'warning', icon: 'user' };
                }
                return { text: 'Không xác định', color: 'secondary', icon: 'question' };
            };

            return vouchers.map(voucher => {
                const typeInfo = getVoucherTypeInfo(voucher);
                return `
            <div class="card mb-3 voucher-item ${this.selectedVoucher?.id === voucher.id ? 'border-primary bg-light' : ''}"
                 style="cursor: pointer;">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3 text-center">
                            <div class="bg-gradient bg-primary text-white rounded-3 p-3 shadow-sm">
                                <div class="h5 mb-0 fw-bold">
                                    ${voucher.loaiGiam === 'PERCENT' ? voucher.giaTriGiam : this.formatCurrency(voucher.giaTriGiam)}
                                </div>
                                <small class="opacity-75">
                                    ${voucher.loaiGiam === 'PERCENT' ? 'Giảm %' : 'Giảm tiền'}
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-2">
                                <h6 class="mb-0 fw-bold me-2">${voucher.ten}</h6>
                                <span class="badge bg-${typeInfo.color}">
                                    <i class="fas fa-${typeInfo.icon} me-1"></i>
                                    ${typeInfo.text}
                                </span>
                            </div>
                            <p class="text-muted small mb-2">${voucher.moTa || 'Áp dụng cho đơn hàng'}</p>
                            <div class="small">
                                <div class="mb-1">
                                    <i class="fas fa-shopping-cart text-info me-1"></i>
                                    <span class="text-success">Đơn tối thiểu: ${this.formatCurrency(voucher.giaTriDonHangToiThieu || 0)}</span>
                                </div>
                                ${voucher.giaTriGiamToiDa ? `
                                    <div class="mb-1">
                                        <i class="fas fa-arrow-up text-warning me-1"></i>
                                        <span class="text-warning">Giảm tối đa: ${this.formatCurrency(voucher.giaTriGiamToiDa)}</span>
                                    </div>
                                ` : ''}
                                <div>
                                    <i class="fas fa-clock text-secondary me-1"></i>
                                    <span class="text-muted">Còn ${voucher.soLuongConLai || 0} lượt sử dụng</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 text-end">
                            <button class="btn ${this.selectedVoucher?.id === voucher.id ? 'btn-success' : 'btn-outline-primary'} btn-sm select-voucher"
                                    data-voucher='${JSON.stringify(voucher)}'>
                                <i class="fas ${this.selectedVoucher?.id === voucher.id ? 'fa-check' : 'fa-plus'} me-1"></i>
                                ${this.selectedVoucher?.id === voucher.id ? 'Đã chọn' : 'Chọn'}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
            }).join('');
        }

        selectVoucher(voucher) {
            this.selectedVoucher = voucher;

            // Update UI
            document.getElementById('voucherCode').value = voucher.ma;

            // Update summary
            this.updateSummary(this.cartData);

            // Update voucher list UI
            document.querySelectorAll('.voucher-item').forEach(item => {
                item.classList.remove('border-primary', 'bg-light');
            });

            document.querySelectorAll('.select-voucher').forEach(btn => {
                const btnVoucher = JSON.parse(btn.dataset.voucher);
                if (btnVoucher.id === voucher.id) {
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-success');
                    btn.innerHTML = '<i class="fas fa-check me-1"></i>Đã chọn';
                    btn.closest('.voucher-item').classList.add('border-primary', 'bg-light');
                } else {
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-primary');
                    btn.innerHTML = '<i class="fas fa-plus me-1"></i>Chọn';
                }
            });

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('voucherModal'));
            modal.hide();

            this.showAlert('Đã chọn phiếu giảm giá thành công!', 'success');
        }

        clearVoucher() {
            this.selectedVoucher = null;

            // Clear voucher input
            document.getElementById('voucherCode').value = '';

            // Update summary
            this.updateSummary(this.cartData);

            // Update voucher list UI
            document.querySelectorAll('.voucher-item').forEach(item => {
                item.classList.remove('border-primary', 'bg-light');
            });

            document.querySelectorAll('.select-voucher').forEach(btn => {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-primary');
                btn.innerHTML = '<i class="fas fa-plus me-1"></i>Chọn';
            });

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('voucherModal'));
            modal.hide();

            this.showAlert('Đã bỏ chọn phiếu giảm giá!', 'info');
        }

        calculateDiscountAmount(originalAmount) {
            if (!this.selectedVoucher) return 0;

            const voucher = this.selectedVoucher;
            let discountAmount = 0;

            // ✅ Sửa: Check loại giảm rõ ràng
            if (voucher.loaiGiam === 'PERCENT') {
                const percent = Number(voucher.giaTriGiam);
                if (isNaN(percent)) {
                    console.error('giaTriGiam is not a number:', voucher.giaTriGiam);
                    return 0;
                }
                discountAmount = originalAmount * (percent / 100);
                console.log(`PERCENT: originalAmount=${originalAmount}, giaTriGiam=${percent}, discountAmount=${discountAmount}`);
            } else {
                discountAmount = Number(voucher.giaTriGiam);
                console.log(`FIXED: discountAmount=${discountAmount}`);
            }

            if (voucher.giaTriGiamToiDa && discountAmount > voucher.giaTriGiamToiDa) {
                discountAmount = voucher.giaTriGiamToiDa;
                console.log(`Applied max discount: ${discountAmount}`);
            }

            return discountAmount;
        }

        validateForm() {
            const form = document.getElementById('checkoutForm');
            form.classList.add('was-validated');

            const required = ['hoTen', 'soDienThoai', 'tinhThanh', 'quanHuyen', 'phuongXa', 'diaChiChiTiet'];
            const isValid = required.every(field => document.getElementById(field).value.trim());

            const payment = document.querySelector('input[name="phuongThucThanhToan"]:checked');

            if (!isValid || !payment) {
                this.showAlert('Vui lòng điền đầy đủ thông tin', 'warning');
                return false;
            }

            return true;
        }

        async processOrder() {
            const formData = new FormData(document.getElementById('checkoutForm'));

            if (this.selectedVoucher) {
                formData.append('voucherId', this.selectedVoucher.id);
            }

            try {
                const response = await fetch('/checkout/process', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                console.log('Process order response:', result); // Thêm log để kiểm tra

                if (result.success) {
                    // Cập nhật UI
                    document.getElementById('discount').textContent = -result.discountAmount; // Cập nhật giảm giá
                    document.getElementById('totalAmount').textContent = result.finalAmount; // Cập nhật tổng cộng

                    // Xử lý theo phương thức thanh toán
                    if (result.paymentMethod === 'MOMO') {
                        // Thanh toán MoMo
                        this.handleMomoPayment(result);
                    } else {
                        // Thanh toán COD
                        this.showAlert('Đặt hàng thành công!', 'success');
                        setTimeout(() => {
                            window.location.href = result.redirectUrl || '/checkout/success?id=' + result.orderId;
                        }, 2000);
                    }

                } else {
                    this.showAlert(result.message || 'Có lỗi xảy ra', 'danger');
                }
            } catch (error) {
                this.showAlert('Lỗi kết nối', 'danger');
            }
        }

        handleMomoPayment(result) {
            if (result.payUrl) {
                // Hiển thị modal xác nhận chuyển hướng
                const confirmed = confirm('Bạn sẽ được chuyển hướng đến trang thanh toán MoMo. Bạn có muốn tiếp tục?');
                if (confirmed) {
                    // Lưu thông tin đơn hàng để kiểm tra sau
                    sessionStorage.setItem('pending_momo_order', result.orderId);
                    sessionStorage.setItem('return_url', window.location.href);
                    
                    // Chuyển hướng đến trang thanh toán MoMo
                    window.location.href = result.payUrl;
                } else {
                    // Người dùng từ chối, có thể hủy đơn hàng hoặc chuyển về COD
                    this.showAlert('Thanh toán bị hủy', 'warning');
                }
            } else {
                // Không có payUrl, có thể là QR code hoặc lỗi
                this.showAlert('Không thể tạo liên kết thanh toán MoMo', 'danger');
            }
        }

        // Kiểm tra trạng thái thanh toán MoMo khi trang load
        checkMomoPaymentStatus() {
            const pendingOrderId = sessionStorage.getItem('pending_momo_order');
            if (pendingOrderId) {
                // Kiểm tra trạng thái thanh toán
                fetch(`/checkout/check-momo-status?orderId=${pendingOrderId}`)
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            // Thanh toán thành công
                            sessionStorage.removeItem('pending_momo_order');
                            sessionStorage.removeItem('return_url');
                            this.showAlert('Thanh toán MoMo thành công!', 'success');
                            setTimeout(() => {
                                window.location.href = '/checkout/success?id=' + pendingOrderId;
                            }, 2000);
                        } else if (result.status === 0) {
                            // Vẫn đang chờ thanh toán
                            this.showAlert('Đơn hàng đang chờ thanh toán MoMo', 'info');
                        } else {
                            // Thanh toán thất bại
                            sessionStorage.removeItem('pending_momo_order');
                            sessionStorage.removeItem('return_url');
                            this.showAlert('Thanh toán MoMo thất bại: ' + result.message, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error checking MoMo status:', error);
                    });
            }
        }

        showAlert(message, type) {
            Swal.fire({
                position: 'top-end',
                icon: type, // success, info, warning, error (maps to danger)
                title: message,
                showConfirmButton: false,
                timer: 2000,
                toast: true,
                background: type === 'success' ? '#d4edda' : type === 'info' ? '#d1ecf1' : type === 'warning' ? '#fff3cd' : '#f8d7da',
                color: type === 'success' ? '#155724' : type === 'info' ? '#0c5460' : type === 'warning' ? '#856404' : '#721c24',
                iconColor: type === 'success' ? '#28a745' : type === 'info' ? '#17a2b8' : type === 'warning' ? '#ffc107' : '#dc3545'
            });
        }
    }

    // Initialize
    const checkoutPage = new CheckoutPage();
    
    // Kiểm tra trạng thái thanh toán MoMo khi trang load
    checkoutPage.checkMomoPaymentStatus();
</script>
</body>
</html>